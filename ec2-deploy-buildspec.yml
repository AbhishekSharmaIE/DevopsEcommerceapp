version: 0.2

env:
  variables:
    INSTANCE_ID: "i-00bb588bfd349593d"
    REGION: "eu-west-1"
    S3_BUCKET: "ecommerce-app-deploy"

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo "Installing dependencies..."
      - python -m pip install --upgrade pip
      - pip install -r requirements.txt

  pre_build:
    commands:
      - echo "Installing Session Manager plugin..."
      - curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
      - sudo dpkg -i session-manager-plugin.deb
      - rm session-manager-plugin.deb

  build:
    commands:
      - echo "Creating deployment package..."
      - tar -czf deploy.tar.gz app/
      - echo "Uploading to S3..."
      - aws s3 cp deploy.tar.gz s3://${S3_BUCKET}/deploy.tar.gz --region ${REGION}
      - echo "Deploying to EC2 instance..."
      - aws ssm send-command --instance-ids "${INSTANCE_ID}" --document-name "AWS-RunShellScript" --comment "Create deployment directory" --parameters '{"commands":["sudo mkdir -p /var/www/html/ecommerce && sudo chown ec2-user:ec2-user /var/www/html/ecommerce"]}' --region ${REGION}
      - aws ssm send-command --instance-ids "${INSTANCE_ID}" --document-name "AWS-RunShellScript" --comment "Deploy application from S3" --parameters '{"commands":["cd /var/www/html/ecommerce && aws s3 cp s3://${S3_BUCKET}/deploy.tar.gz . && tar -xzf deploy.tar.gz && rm deploy.tar.gz"]}' --region ${REGION}
      - echo "Verifying deployment..."
      - aws ssm send-command --instance-ids "${INSTANCE_ID}" --document-name "AWS-RunShellScript" --comment "Verify deployment" --parameters '{"commands":["ls -la /var/www/html/ecommerce/app"]}' --region ${REGION}
      - echo "Deployment completed. Application URL: http://ec2-34-243-69-123.eu-west-1.compute.amazonaws.com"

artifacts:
  files:
    - "**/*"
  name: DeployArtifact
