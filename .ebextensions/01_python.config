option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: application:app
  aws:elasticbeanstalk:application:environment:
    FLASK_APP: application.py
    FLASK_ENV: production
    PORT: 5000
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
  aws:elasticbeanstalk:container:python:staticfiles:
    /static/: static/

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_supervisor.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      # Get directory where the script is running
      DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
      
      # Create supervisor configuration
      cat > /etc/supervisor/conf.d/flask.conf << EOF
      [program:flask]
      directory=/var/app/current
      command=gunicorn --bind 0.0.0.0:5000 --workers 3 --timeout 120 application:app
      autostart=true
      autorestart=true
      stderr_logfile=/var/log/flask.err.log
      stdout_logfile=/var/log/flask.out.log
      user=webapp
      EOF
      
      # Reload supervisor configuration
      supervisorctl reread
      supervisorctl update
      supervisorctl restart flask

container_commands:
  01_install_requirements:
    command: |
      source /var/app/venv/*/bin/activate
      pip install -r requirements.txt
      pip install supervisor gunicorn
  02_setup_supervisor:
    command: |
      yum -y install supervisor
      mkdir -p /etc/supervisor/conf.d
      echo_supervisord_conf > /etc/supervisord.conf
      echo "[include]" >> /etc/supervisord.conf
      echo "files = /etc/supervisor/conf.d/*.conf" >> /etc/supervisord.conf
      /usr/local/bin/supervisord -c /etc/supervisord.conf
  03_chmod_app:
    command: "chmod +x application.py" 