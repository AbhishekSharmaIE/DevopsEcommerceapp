option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: application:app
  aws:elasticbeanstalk:application:environment:
    FLASK_APP: application.py
    FLASK_ENV: production
    PORT: 5000
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
  aws:elasticbeanstalk:container:python:staticfiles:
    /static/: static/

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      # Get to the application directory
      cd /var/app/current

      # Create run directory for gunicorn
      mkdir -p /var/run/gunicorn
      chown webapp:webapp /var/run/gunicorn

      # Start gunicorn with the correct permissions
      exec su webapp -c 'gunicorn \
        --bind 0.0.0.0:5000 \
        --workers 3 \
        --timeout 120 \
        --access-logfile /var/log/gunicorn-access.log \
        --error-logfile /var/log/gunicorn-error.log \
        --capture-output \
        --log-level debug \
        application:app'

container_commands:
  01_install_requirements:
    command: |
      source /var/app/venv/*/bin/activate
      pip install -r requirements.txt
      pip install gunicorn
  02_create_logs:
    command: |
      mkdir -p /var/log/gunicorn
      touch /var/log/gunicorn-access.log /var/log/gunicorn-error.log
      chown -R webapp:webapp /var/log/gunicorn*
  03_chmod_app:
    command: |
      chmod +x application.py
      chown -R webapp:webapp /var/app/current/ 